apiVersion: v1
kind: Secret
metadata:
  name: two-tier-vm-mysql-cloudinit-bootstrap-secret
  namespace: test-ns01
  labels:
    vm-selector: two-tier-vm-mysql
stringData:
  user-data: |
    #cloud-config
    package_update: true
    package_upgrade: false
    
    packages:
      - mysql-server
      - mysql-client-core-8.0
      - unzip
      - open-vm-tools
    
    users:
      - name: demouser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
        lock_passwd: false
        chpasswd: 
          list: |
            demouser: VMware123!VMware123!
          expire: False
        ssh_pwauth: True
      - name: ocuser
        sudo: ['ALL=(ALL) NOPASSWD:ALL']
        groups: sudo
        shell: /bin/bash
        passwd: $6$Iab8vzOD6yh667p8$6kAVfSLB9z.VijKjp0F/cbiKpC6An5.5NPLEuE5fhewQsGeUV906/gdiwfNZxsRvYu8LKjiumC2gxkO3pmGrM/
        chpasswd: 
          expire: False
        ssh_pwauth: True
    
    write_files:
      # Password Authentication via SSH
      - path: /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
        content: |
          PasswordAuthentication yes
          AllowUsers demouser ocuser
      # Permanent DNS via Netplan
      - path: /etc/netplan/01-netcfg-dns.yaml
        content: |
          network:
            version: 2
            ethernets:
              eth0:
                mtu: 1500
                nameservers:
                  addresses:
                    - 10.1.1.1
                    - 8.8.8.8
      # Cron job for opencart cleanup
      - path: /etc/cron.hourly/oc_cleanup
        owner: root
        permissions: '0777'
        content: |
          #!/bin/bash
          mysql -uroot -proot -e "USE opencart; CREATE TABLE oc_session_copy LIKE oc_session; DROP TABLE oc_session; RENAME TABLE oc_session_copy TO oc_session;"
      # Hosts entry for oc-mysql
      - path: /etc/hosts
        content: |
          127.0.0.1 oc-mysql
        append: true
    
    runcmd:
      - export DEBIAN_FRONTEND=noninteractive
      - USER=ocuser
      - PASS=VMware1!
      - hostnamectl set-hostname mysql
      # Apply netplan so DNS works immediately
      - netplan apply
      # Ensure MySQL service is enabled and started
      - systemctl enable mysql
      - systemctl start mysql
      - sleep 5
      # Confirm mysql client exists
      - mysql --version
      # Switch root to password auth
      - mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"
      # Allow remote access
      - sed -i 's/^bind-address/#bind-address/' /etc/mysql/mysql.conf.d/mysqld.cnf
      - systemctl restart mysql
      # Restart sshd to have settings take effect
      - systemctl restart ssh
      # Create application user and grant permissions
      - mysql -uroot -proot -e "CREATE USER IF NOT EXISTS '$USER'@'%' IDENTIFIED BY '$PASS'; GRANT ALL PRIVILEGES ON *.* TO '$USER'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
      # Create application database
      - mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS opencart;"
      - echo 'Cloud-init is done!' >> /tmp/finished.txt
